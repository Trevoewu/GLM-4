# CMCC-34 数据集 LLM 样本合成增强方案

## 问题背景

CMCC-34数据集存在严重的类别不平衡问题：
- 最多类别：咨询（含查询）业务规定 (1,961个样本，15.3%)
- 最少类别：咨询（含查询）电商货品信息、办理销户/重开 (各1个样本，0.01%)
- 样本数差异高达1,960倍

这种极端不平衡会导致：
1. 模型偏向于预测多数类别
2. 少数类别召回率极低
3. 整体F1分数下降
4. 泛化能力差

## 解决方案

### LLM样本合成增强

我们采用基于LLM的样本合成方法来解决类别不平衡问题：

#### 核心思想
1. **分析现有分布**：识别少数类别和极少数类别
2. **提取类别特征**：为每个类别定义关键词和模式
3. **LLM样本生成**：使用GLM-4等大语言模型生成高质量的合成样本
4. **质量控制**：确保生成样本的质量和多样性
5. **数据集平衡**：创建更平衡的训练数据集

#### 技术优势
- **高质量**：LLM生成的样本更加自然和真实
- **可控性**：通过精心设计的提示词控制生成质量
- **多样性**：避免简单的复制粘贴，提供真实的语言变化
- **领域适应**：针对电信客服场景优化

## 使用方法

### 1. 环境准备

```bash
# 安装依赖
pip install pandas pyyaml requests

# 确保数据文件存在
ls train_new.csv dev_new.csv
```

### 2. 配置LLM服务

#### 选项A：使用本地GLM-4服务
```bash
# 启动GLM-4推理服务（在另一个终端）
cd ../../inference
python glm4v_server.py --port 8000
```

#### 选项B：使用OpenAI API
```yaml
# 修改 augment_config.yaml
llm_config:
  api_url: "https://api.openai.com/v1/chat/completions"
  api_key: "your-openai-api-key"
  model_name: "gpt-3.5-turbo"
```

### 3. 运行数据增强

#### 预览模式（不生成实际样本）
```bash
python run_augmentation.py --dry-run
```

#### 完整增强
```bash
python run_augmentation.py
```

#### 自定义配置
```bash
python run_augmentation.py --config custom_config.yaml
```

#### 仅转换已有数据
```bash
python run_augmentation.py --convert-only
```

### 4. 使用增强后的数据训练

```bash
# 使用平衡后的数据集
python ../../train_cmcc34_system_prompt.py

# 或者手动指定数据文件
python ../../finetune.py data/cmcc-34 THUDM/GLM-4-9B-0414 configs/cmcc34_qlora.yaml
```

## 配置说明

### 核心参数

```yaml
augmentation:
  target_samples_per_class: 100  # 每个类别的目标样本数
  minority_threshold_ratio: 0.3   # 少数类别阈值比例
  batch_size: 5                   # 每次生成的样本数
```

### 质量控制

```yaml
quality_control:
  enable_similarity_check: true   # 检查与原始样本的相似度
  enable_length_check: true       # 检查对话长度
  enable_keyword_check: true      # 检查是否包含相关关键词
  manual_review_ratio: 0.1        # 人工审核比例
```

### 特定类别策略

```yaml
class_specific_strategies:
  ultra_minority:
    - 32  # 办理销户/重开 (1个样本)
    - 33  # 咨询电商货品信息 (1个样本)
    target_multiplier: 20  # 增加到20倍
```

## 生成示例

### 原始样本（类别32：办理销户/重开）
```
"您好请讲[SEP]我想销户[SEP]您需要本人持身份证到营业厅办理[SEP]好的谢谢"
```

### 生成的合成样本
```
对话1：您好请讲[SEP]我要办理手机号注销业务[SEP]您好，请问是要销户吗[SEP]对，不用这个号码了[SEP]好的，需要您本人带身份证到营业厅办理

对话2：你好[SEP]我的手机号不想要了，怎么销户[SEP]您好，销户需要本人到营业厅办理，请带好身份证[SEP]有没有其他方式[SEP]目前只能到营业厅办理

对话3：您好[SEP]我想重新开通之前销户的号码[SEP]您好，已销户的号码可以申请重开，但需要看号码状态[SEP]怎么查状态[SEP]您可以到营业厅查询重开业务
```

## 效果评估

### 数据增强前后对比

| 类别ID | 类别名称 | 原始样本数 | 增强后样本数 | 改善倍数 |
|--------|----------|------------|--------------|----------|
| 0 | 咨询业务规定 | 1,961 | 1,961 | 1.0x |
| 32 | 办理销户/重开 | 1 | 100 | 100x |
| 33 | 咨询电商货品 | 1 | 100 | 100x |
| 26 | 办理打印/邮寄 | 15 | 100 | 6.7x |
| ... | ... | ... | ... | ... |

### 预期改善

1. **类别平衡度**：基尼系数从0.85降低到0.35
2. **少数类别召回率**：从10%提升到70%+
3. **宏平均F1**：预计提升15-25%
4. **模型泛化能力**：在测试集上更稳定的表现

## 质量保证

### 自动质量检查
1. **长度检查**：确保对话长度在合理范围内
2. **关键词检查**：验证是否包含类别相关关键词
3. **相似度检查**：避免与原始样本过于相似
4. **格式检查**：确保符合对话格式要求

### 人工审核
- 随机抽取10%的合成样本进行人工审核
- 审核标准：内容合理性、类别准确性、语言自然性
- 不合格样本会被移除并重新生成

## 注意事项

### 1. API成本控制
- 使用本地GLM-4服务可以避免API费用
- 如使用商业API，注意控制调用频率和总量
- 建议分批次进行，避免一次性生成过多样本

### 2. 生成质量
- 定期检查生成样本的质量
- 调整提示词和生成参数以优化效果
- 保留人工审核机制

### 3. 数据隐私
- 确保生成的样本不包含真实用户信息
- 定期检查是否有敏感信息泄露

### 4. 模型偏差
- 注意LLM可能带来的偏差
- 通过多样化的提示词减少偏差
- 定期评估生成样本的分布

## 文件结构

```
cmcc-34/
├── data_augmentation.py           # 核心增强逻辑
├── run_augmentation.py           # 运行脚本
├── augment_config.yaml          # 配置文件
├── README_augmentation.md       # 说明文档
├── train_new.csv               # 原始训练数据
├── train_balanced.csv          # 增强后训练数据
├── train_balanced.jsonl        # GLM-4格式训练数据
├── synthetic_samples.json      # 合成样本详情
├── augmentation.log           # 日志文件
└── samples_for_review.json    # 待人工审核样本
```

## 扩展功能

### 1. 多模型集成
- 可以同时使用多个LLM生成样本
- 通过投票机制选择最佳样本

### 2. 主动学习
- 根据模型训练结果调整增强策略
- 重点增强模型表现差的类别

### 3. 样本质量评分
- 使用额外的模型对生成样本评分
- 只保留高质量样本

### 4. 增量增强
- 支持在训练过程中动态增加样本
- 根据验证结果调整数据分布

## 故障排除

### 常见问题

1. **API连接失败**
   - 检查网络连接和API地址
   - 验证API密钥是否正确
   - 尝试使用备用API

2. **生成质量差**
   - 调整temperature参数
   - 优化提示词设计
   - 增加示例样本数量

3. **内存不足**
   - 减少batch_size
   - 分批次处理数据
   - 清理中间结果

4. **生成速度慢**
   - 使用更快的API服务
   - 并行处理多个类别
   - 减少每个类别的目标样本数

如有问题，请查看日志文件或联系开发者。